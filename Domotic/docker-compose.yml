services:
  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - api
      - grafana
      - phpmyadmin
      - portainer
      - nextcloud
    networks:
      - domotic-net
      - shared-network
      - fourltrophy-network

  # Let's Encrypt SSL Certificate Manager
  certbot:
    image: certbot/certbot
    container_name: certbot
    restart: "no"
    user: "0:0"  # Run as root to avoid permission issues
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
      - ./nginx/ssl:/etc/nginx/ssl
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do sleep 1; done;'"

  api:
    build: ./api
    container_name: api
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_BROKER=${MQTT_BROKER}
      - TZ=${TIMEZONE}
    depends_on:
      - mosquitto
      - db
    networks:
      - domotic-net

  listener:
    build: ./services
    container_name: listenner
    restart: unless-stopped
    environment:
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_BROKER=${MQTT_BROKER}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - TZ=${TIMEZONE}
    depends_on:
      - mosquitto
      - db
    networks:
      - domotic-net

  mosquitto:
    image: eclipse-mosquitto:latest
    hostname: mosquitto
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config:rw
      - ./mosquitto/data:/mosquitto/data:rw
      - ./mosquitto/log:/mosquitto/log:rw
    environment:
      - TZ=${TIMEZONE}
    networks:
      - domotic-net

  db:
    image: postgres:latest
    container_name: db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: ${TIMEZONE}
    expose:
      - "5432"
    volumes:
      - ./Data/init.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data
    networks:
      - domotic-net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    restart: always
    environment:
      PMA_HOST: nextcloud-db
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      PMA_ABSOLUTE_URI: https://${SUBDOMAIN_PHPMYADMIN}.${DOMAIN}/
      UPLOAD_LIMIT: 100M
      TZ: ${TIMEZONE}
    expose:
      - "80"
    depends_on:
      - nextcloud-db
    networks:
      - domotic-net

  grafana:
    image: grafana/grafana
    container_name: grafana
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://${SUBDOMAIN_GRAFANA}.${DOMAIN}
      GF_SERVER_DOMAIN: ${SUBDOMAIN_GRAFANA}.${DOMAIN}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
      TZ: ${TIMEZONE}
    depends_on:
      - db
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - domotic-net

  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    restart: unless-stopped
    expose:
      - "9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    environment:
      - TZ=${TIMEZONE}
    networks:
      - domotic-net

  # Nextcloud with MySQL
  nextcloud-db:
    image: mysql:8.0
    container_name: nextcloud-db
    restart: always
    command: --default-authentication-plugin=mysql_native_password --bind-address=0.0.0.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_ROOT_HOST: '%'
      TZ: ${TIMEZONE}
    volumes:
      - nextcloud_db:/var/lib/mysql
    networks:
      - domotic-net

  nextcloud:
    image: nextcloud:apache
    container_name: nextcloud
    restart: always
    expose:
      - "80"
    environment:
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_HOST: nextcloud-db
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
      NEXTCLOUD_TRUSTED_DOMAINS: ${SUBDOMAIN_NEXTCLOUD}.${DOMAIN}
      OVERWRITEHOST: ${SUBDOMAIN_NEXTCLOUD}.${DOMAIN}
      OVERWRITEPROTOCOL: https
      APACHE_DISABLE_REWRITE_IP: 1
      TRUSTED_PROXIES: nginx
      TZ: ${TIMEZONE}
    volumes:
      - nextcloud_data:/var/www/html
    depends_on:
      - nextcloud-db
    networks:
      - domotic-net

volumes:
  portainer_data:
  postgres_data:
  grafana_data:
  nextcloud_data:
  nextcloud_db:
  nginx_logs:

networks:
  domotic-net:
    driver: bridge
  shared-network:
    external: true
    name: shared-network
  fourltrophy-network:
    external: true
    name: la-4l-des-domes_fourltrophy-network